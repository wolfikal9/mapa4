<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mi Lotificación Interactiva</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    </style>
</head>
<body>

<div id="map"></div>

<script>
    // TU TOKEN DE ACCESO
    mapboxgl.accessToken = 'pk.eyJ1IjoibWFxbGVlbXgiLCJhIjoiY21oOGxka2szMGNucTJrcHllcWxkdm16aiJ9.OBNZDRRAC7D4BTeVUUAU3w'; 
    
    const map = new mapboxgl.Map({ 
        container: 'map', // ID del div
        style: 'mapbox://styles/maqleemx/cmh9idn5p009r01ra9hqh128w', // URL de tu estilo
        center: [-117.0005, 32.2935], // Coordenadas [Lng, Lat] del centro de tu proyecto
        zoom: 15 // Zoom inicial
    });

    // --- INICIA CÓDIGO DE GEOLOCALIZACIÓN ---
    // 1. Crea el control de geolocalización
    const geolocate = new mapboxgl.GeolocateControl({
        positionOptions: {
            enableHighAccuracy: true // Pide la ubicación más precisa (GPS)
        },
        trackUserLocation: true, // Sigue al usuario en tiempo real
        showUserHeading: true // Muestra una flecha con la dirección a la que mira
    });

    // 2. Añade el control al mapa (aparecerá un botón en la esquina)
    map.addControl(geolocate);
    // --- TERMINA CÓDIGO DE GEOLOCALIZACIÓN ---


    // --- AQUÍ EMPIEZA LA MAGIA DE LA INTERACTIVIDAD ---

    map.on('load', () => {

        // --- CÓDIGO PARA COLORES ---
        map.setPaintProperty(
            'mapa4',    // El ID de tu capa de lotes
            'fill-color',   // La propiedad que queremos cambiar
            [
                'match', // Usamos una expresión 'match'
                ['get', 'STATUS'], // Obtiene el valor de la propiedad "STATUS"
                
                // Nuestra lógica: Valor -> Color
                1, '#28a745', // STATUS 1 (Disponible) = Verde
                2, '#fd7e14', // STATUS 2 (Apartado) = Naranja
                3, '#dc3545', // STATUS 3 (Vendido) = Rojo
                
                // Un color por defecto si no es 1, 2, o 3
                '#808080' 
            ]
        );
        // --- TERMINA CÓDIGO PARA COLORES ---


        // 'map.on('click'...' vigila los clics en el mapa.
        map.on('click', 'mapa4', (e) => {
            
            // Obtiene las propiedades del lote en el que se hizo clic
            const properties = e.features[0].properties;
            
            
            // --- Lógica para traducir el Estatus ---
            let estatusTexto = 'No definido'; 
            const statusNum = Number(properties.STATUS); 

            if (statusNum === 1) {
                estatusTexto = 'Disponible';
            } else if (statusNum === 2) {
                estatusTexto = 'Apartado';
            } else if (statusNum === 3) {
                estatusTexto = 'Vendido';
            }
            // --- Fin de la lógica del Estatus ---


            // 4. Construye el texto del Pop-up en el orden que pediste
            const htmlPopup = `
                <h3>Lote: ${properties.LOTE || 'N/A'}</h3>
                <p><strong>Área:</strong> ${ properties.AREA != null ? parseFloat(properties.AREA).toFixed(2) : 'N/A' } m²</p>
                <p><strong>Estatus:</strong> ${estatusTexto}</p>
            `;
            // --- FIN DE LA MODIFICACIÓN ---

            // Crea el pop-up y lo añade al mapa
            new mapboxgl.Popup()
                .setLngLat(e.lngLat) // Posición del clic
                .setHTML(htmlPopup) // Contenido HTML
                .addTo(map);
        });

        // Cambia el cursor a 'pointer' (manita) cuando pasa sobre un lote
        map.on('mouseenter', 'mapa4', () => {
            map.getCanvas().style.cursor = 'pointer';
        });

        // Lo revierte a normal cuando sale
        map.on('mouseleave', 'mapa4', () => {
            map.getCanvas().style.cursor = '';
        });
    });
</script>

</body>
</html>